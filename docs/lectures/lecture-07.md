# –õ–µ–∫—Ü—ñ—è 7. –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–∞ –±–µ–∑–ø–µ–∫–∞

## –í—Å—Ç—É–ø –¥–æ –±–µ–∑–ø–µ–∫–∏ –≤–µ–±–¥–æ–¥–∞—Ç–∫—ñ–≤

–ë–µ–∑–ø–µ–∫–∞ –≤–µ–±–¥–æ–¥–∞—Ç–∫—ñ–≤ —î –æ–¥–Ω–∏–º –∑ –Ω–∞–π–∫—Ä–∏—Ç–∏—á–Ω—ñ—à–∏—Ö –∞—Å–ø–µ–∫—Ç—ñ–≤ —Å—É—á–∞—Å–Ω–æ—ó —Ä–æ–∑—Ä–æ–±–∫–∏. –£ —Å–≤—ñ—Ç—ñ, –¥–µ –∫—ñ–±–µ—Ä–∑–∞–≥—Ä–æ–∑–∏ –∑—Ä–æ—Å—Ç–∞—é—Ç—å –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–∞–ª—å–Ω–æ, —Ä–æ–∑—É–º—ñ–Ω–Ω—è –ø—Ä–∏–Ω—Ü–∏–ø—ñ–≤ –±–µ–∑–ø–µ–∫–∏ —Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–µ—Ö–∞–Ω—ñ–∑–º—ñ–≤ –∑–∞—Ö–∏—Å—Ç—É —Å—Ç–∞—é—Ç—å –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º–∏ –Ω–∞–≤–∏—á–∫–∞–º–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –≤–µ–±—Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞.

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ñ–±–µ—Ä–∑–ª–æ—á–∏–Ω–Ω–æ—Å—Ç—ñ –ø–æ–∫–∞–∑—É—î —Ç—Ä–∏–≤–æ–∂–Ω—ñ —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—ó: —â–æ—Ä–æ–∫—É —Ä–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è –º—ñ–ª—å–π–æ–Ω–∏ –∞—Ç–∞–∫ –Ω–∞ –≤–µ–±–¥–æ–¥–∞—Ç–∫–∏, –∞ —Å–µ—Ä–µ–¥–Ω—ñ –≤—Ç—Ä–∞—Ç–∏ –≤—ñ–¥ –æ–¥–Ω—ñ—î—ó —É—Å–ø—ñ—à–Ω–æ—ó –∞—Ç–∞–∫–∏ —Å—Ç–∞–Ω–æ–≤–ª—è—Ç—å —Å–æ—Ç–Ω—ñ —Ç–∏—Å—è—á –¥–æ–ª–∞—Ä—ñ–≤. –ë—ñ–ª—å—à—ñ—Å—Ç—å —Ü–∏—Ö –∞—Ç–∞–∫ –º–æ–∂–Ω–∞ –±—É–ª–æ –± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –±–∞–∑–æ–≤–∏—Ö –ø—Ä–∏–Ω—Ü–∏–ø—ñ–≤ –±–µ–∑–ø–µ–∫–∏.

–ë–µ–∑–ø–µ–∫–∞ –≤–µ–±–¥–æ–¥–∞—Ç–∫—ñ–≤ –æ—Ö–æ–ø–ª—é—î –±–∞–≥–∞—Ç–æ –∞—Å–ø–µ–∫—Ç—ñ–≤: –≤—ñ–¥ –∑–∞—Ö–∏—Å—Ç—É –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏. –û—Å–Ω–æ–≤–Ω—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∏ –≤–∫–ª—é—á–∞—é—Ç—å –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ—Å—Ç—å, —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó. –ö–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ—Å—Ç—å –∑–∞–±–µ–∑–ø–µ—á—É—î, —â–æ –¥–∞–Ω—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º. –¶—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –¥–∞–Ω—ñ –Ω–µ –±—É–ª–∏ –∑–º—ñ–Ω–µ–Ω—ñ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–æ. –î–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å –æ–∑–Ω–∞—á–∞—î, —â–æ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—é –¥–ª—è –ª–µ–≥—ñ—Ç–∏–º–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.

## –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è vs –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è: —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ñ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó

–ü–µ—Ä—à –Ω—ñ–∂ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏ –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–π, –≤–∞–∂–ª–∏–≤–æ —á—ñ—Ç–∫–æ —Ä–æ–∑—É–º—ñ—Ç–∏ —Ä—ñ–∑–Ω–∏—Ü—é –º—ñ–∂ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—î—é, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü—ñ –ø–æ–Ω—è—Ç—Ç—è —á–∞—Å—Ç–æ –ø–ª—É—Ç–∞—é—Ç—å.

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è** ‚Äì —Ü–µ –ø—Ä–æ—Ü–µ—Å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ—Å–æ–±–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –í–æ–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è "–•—Ç–æ –≤–∏?". –ü—ñ–¥ —á–∞—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –¥—ñ–π—Å–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î —Ç–∏–º, –∑–∞ –∫–æ–≥–æ —Å–µ–±–µ –≤–∏–¥–∞—î. –¶–µ –º–æ–∂–µ –≤—ñ–¥–±—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ —Ä—ñ–∑–Ω—ñ –º–µ—Ö–∞–Ω—ñ–∑–º–∏: –ø–∞—Ä–æ–ª—å, –±—ñ–æ–º–µ—Ç—Ä—ñ—è, —Ç–æ–∫–µ–Ω–∏, —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏.

**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è** ‚Äì —Ü–µ –ø—Ä–æ—Ü–µ—Å –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–æ–≥–æ, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –ø—Ä–∞–≤–æ —Ä–æ–±–∏—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—ñ. –í–æ–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è "–©–æ –≤–∏ –º–æ–∂–µ—Ç–µ —Ä–æ–±–∏—Ç–∏?". –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —ñ –≤–∏–∑–Ω–∞—á–∞—î, –¥–æ —è–∫–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –¥–æ—Å—Ç—É–ø —Ç–∞ —è–∫—ñ –¥—ñ—ó –º–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏.

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –∫–æ–ª–∏ –≤–∏ –≤—Ö–æ–¥–∏—Ç–µ –≤ –±–∞–Ω–∫—ñ–≤—Å—å–∫—É —Å–∏—Å—Ç–µ–º—É, —Å–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —á–µ—Ä–µ–∑ –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å. –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑—É—î –≤–∞—Å –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –≤–∞—à–∏—Ö —Ä–∞—Ö—É–Ω–∫—ñ–≤, –∞–ª–µ –Ω–µ –¥–æ —Ä–∞—Ö—É–Ω–∫—ñ–≤ —ñ–Ω—à–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤.

## –°–µ—Å—ñ—ó vs —Ç–æ–∫–µ–Ω–∏: –ø–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑

### –°–µ—Å—ñ–π–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è: —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥

–°–µ—Å—ñ–π–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ —Å—Ç–∞–Ω—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ. –ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —É—Å–ø—ñ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é, —Å–µ—Ä–≤–µ—Ä —Å—Ç–≤–æ—Ä—é—î —Å–µ—Å—ñ—é ‚Äì —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä, —è–∫–∏–π –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –ø–∞–º'—è—Ç—ñ —Å–µ—Ä–≤–µ—Ä–∞ –∞–±–æ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö. –ö–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î —Ü–µ–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∑–∞–∑–≤–∏—á–∞–π —É –≤–∏–≥–ª—è–¥—ñ cookie.

```mermaid
sequenceDiagram
    participant Client
    participant Server
    participant SessionStore

    Client->>Server: POST /login (credentials)
    Server->>SessionStore: Create session
    SessionStore-->>Server: Session ID
    Server-->>Client: Set-Cookie: sessionId=abc123

    Client->>Server: GET /protected (cookie: sessionId=abc123)
    Server->>SessionStore: Validate session
    SessionStore-->>Server: Session data
    Server-->>Client: Protected resource
```

–ü–µ—Ä–µ–≤–∞–≥–∏ —Å–µ—Å—ñ–π–Ω–æ—ó –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –≤–∫–ª—é—á–∞—é—Ç—å –ø—Ä–æ—Å—Ç–æ—Ç—É —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó, –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ª–µ–≥–∫–æ–≥–æ –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É, —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–µ—Å—ñ—è–º–∏ —Ç–∞ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Å–µ—Å—ñ—é. –°–µ—Ä–≤–µ—Ä –º–∞—î –ø–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∞–∫—Ç–∏–≤–Ω–∏–º–∏ —Å–µ—Å—ñ—è–º–∏ —ñ –º–æ–∂–µ –º–∏—Ç—Ç—î–≤–æ —ó—Ö –ø—Ä–∏–ø–∏–Ω–∏—Ç–∏.

–ù–µ–¥–æ–ª—ñ–∫–∏ –ø–æ–ª—è–≥–∞—é—Ç—å —É –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ, —â–æ —É—Å–∫–ª–∞–¥–Ω—é—î –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è. –ü—Ä–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ –∫—ñ–ª—å–∫–æ—Ö —Å–µ—Ä–≤–µ—Ä—ñ–≤ –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Å–µ—Å—ñ–π –∞–±–æ sticky sessions. –¢–∞–∫–æ–∂ —ñ—Å–Ω—É—î –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –≤—ñ–¥ cookies, —â–æ –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –ø—Ä–æ–±–ª–µ–º–∏ –≤ –¥–µ—è–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—è—Ö.

### –¢–æ–∫–µ–Ω–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è: —Å—É—á–∞—Å–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥

–¢–æ–∫–µ–Ω–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è, –æ—Å–æ–±–ª–∏–≤–æ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º JSON Web Tokens (JWT), –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—î stateless –ø—ñ–¥—Ö—ñ–¥. –ó–∞–º—ñ—Å—Ç—å –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ, –≤—Å—è –Ω–µ–æ–±—Ö—ñ–¥–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –∫–æ–¥—É—î—Ç—å—Å—è –≤ —Ç–æ–∫–µ–Ω—ñ, —è–∫–∏–π –ø—ñ–¥–ø–∏—Å—É—î—Ç—å—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º.

JWT —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —Ç—Ä—å–æ—Ö —á–∞—Å—Ç–∏–Ω, —Ä–æ–∑–¥—ñ–ª–µ–Ω–∏—Ö –∫—Ä–∞–ø–∫–∞–º–∏:
- **Header**: –º—ñ—Å—Ç–∏—Ç—å —Ç–∏–ø —Ç–æ–∫–µ–Ω–∞ —Ç–∞ –∞–ª–≥–æ—Ä–∏—Ç–º –ø—ñ–¥–ø–∏—Å—É
- **Payload**: –º—ñ—Å—Ç–∏—Ç—å claims (—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è) –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- **Signature**: –∑–∞–±–µ–∑–ø–µ—á—É—î —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞

```javascript
// –ü—Ä–∏–∫–ª–∞–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ JWT
const header = {
    "alg": "HS256",
    "typ": "JWT"
};

const payload = {
    "sub": "1234567890",
    "name": "–Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ",
    "role": "user",
    "iat": 1516239022,
    "exp": 1516325422
};

// –†–µ–∑—É–ª—å—Ç—É—é—á–∏–π JWT:
// eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
// eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.
// SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

–ü–µ—Ä–µ–≤–∞–≥–∏ JWT –≤–∫–ª—é—á–∞—é—Ç—å –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Å—Ç–∞–Ω—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ, —â–æ —Å–ø—Ä–æ—â—É—î –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è, –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –º—ñ–∂—Å–µ—Ä–≤—ñ—Å–Ω–æ—ó –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –≤—ñ–¥ cookies —Ç–∞ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–Ω—è –º–µ—Ç–∞–¥–∞–Ω–∏—Ö –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ —Ç–æ–∫–µ–Ω.

–ù–µ–¥–æ–ª—ñ–∫–∏ –ø–æ–ª—è–≥–∞—é—Ç—å —É —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ –≤—ñ–¥–∫–ª–∏–∫–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ –¥–æ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ç–µ—Ä–º—ñ–Ω—É –¥—ñ—ó, –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –±—ñ–ª—å—à–æ–º—É —Ä–æ–∑–º—ñ—Ä—É –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ session ID —Ç–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ —Ä–µ—Ç–µ–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–µ–∫—Ä–µ—Ç–Ω–∏–º–∏ –∫–ª—é—á–∞–º–∏.

```mermaid
sequenceDiagram
    participant Client
    participant AuthServer
    participant ResourceServer

    Client->>AuthServer: POST /login (credentials)
    AuthServer-->>Client: JWT token

    Client->>ResourceServer: GET /protected (Bearer JWT)
    ResourceServer->>ResourceServer: Verify JWT signature
    ResourceServer-->>Client: Protected resource
```

## –•–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤: –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω–∞ –±–µ–∑–ø–µ–∫–∞

–ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤ —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É –≤–∏–≥–ª—è–¥—ñ —î –æ–¥–Ω–∏–º –∑ –Ω–∞–π–≥—Ä—É–±—ñ—à–∏—Ö –ø–æ—Ä—É—à–µ–Ω—å –±–µ–∑–ø–µ–∫–∏. –ü–∞—Ä–æ–ª—ñ –∑–∞–≤–∂–¥–∏ –ø–æ–≤–∏–Ω–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è —É —Ö–µ—à–æ–≤–∞–Ω–æ–º—É –≤–∏–≥–ª—è–¥—ñ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω–æ —Å—Ç—ñ–π–∫–∏—Ö –∞–ª–≥–æ—Ä–∏—Ç–º—ñ–≤.

### –ü—Ä–æ–±–ª–µ–º–∏ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ö–µ—à—É–≤–∞–Ω–Ω—è

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø—Ä–æ—Å—Ç–∏—Ö —Ö–µ—à-—Ñ—É–Ω–∫—Ü—ñ–π —è–∫ MD5 –∞–±–æ SHA-1 –¥–ª—è –ø–∞—Ä–æ–ª—ñ–≤ —î –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–º —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ –ø—Ä–∏—á–∏–Ω. –ü–æ-–ø–µ—Ä—à–µ, —Ü—ñ –∞–ª–≥–æ—Ä–∏—Ç–º–∏ —Ä–æ–∑—Ä–æ–±–ª–µ–Ω—ñ –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ, —â–æ —Ä–æ–±–∏—Ç—å —ó—Ö –≤—Ä–∞–∑–ª–∏–≤–∏–º–∏ –¥–æ brute-force –∞—Ç–∞–∫. –ü–æ-–¥—Ä—É–≥–µ, –æ–¥–Ω–∞–∫–æ–≤—ñ –ø–∞—Ä–æ–ª—ñ –∑–∞–≤–∂–¥–∏ –¥–∞—é—Ç—å –æ–¥–Ω–∞–∫–æ–≤–∏–π —Ö–µ—à, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∞—Ç–∞–∫—É–≤–∞—Ç–∏ —ó—Ö —á–µ—Ä–µ–∑ rainbow tables.

```javascript
// –ù–ï–ë–ï–ó–ü–ï–ß–ù–û: –ø—Ä–æ—Å—Ç–∏–π —Ö–µ—à –±–µ–∑ —Å–æ–ª—ñ
const crypto = require('crypto');
const password = "mypassword123";
const hash = crypto.createHash('sha256').update(password).digest('hex');
// –û–¥–∏–Ω–∞–∫–æ–≤–∏–π –ø–∞—Ä–æ–ª—å –∑–∞–≤–∂–¥–∏ –¥–∞—î –æ–¥–∏–Ω–∞–∫–æ–≤–∏–π —Ö–µ—à
```

### Bcrypt: –∑–æ–ª–æ—Ç–∏–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç

Bcrypt —î adaptive hashing —Ñ—É–Ω–∫—Ü—ñ—î—é, —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–æ—é –¥–ª—è —Ö–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤. –í—ñ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∫–ª—é—á–∞—î —Å—ñ–ª—å —Ç–∞ –¥–æ–∑–≤–æ–ª—è—î –Ω–∞–ª–∞—à—Ç–æ–≤—É–≤–∞—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –æ–±—á–∏—Å–ª–µ–Ω—å.

```javascript
const bcrypt = require('bcryptjs');

// –•–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è
async function hashPassword(password) {
    const saltRounds = 12; // –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–∞—É–Ω–¥—ñ–≤ —Å–æ–ª—ñ
    const hashedPassword = await bcrypt.hash(password, saltRounds);
    return hashedPassword;
}

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
async function verifyPassword(password, hashedPassword) {
    const isValid = await bcrypt.compare(password, hashedPassword);
    return isValid;
}

// –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
async function registerUser(email, password) {
    try {
        const hashedPassword = await hashPassword(password);

        // –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
        const user = await User.create({
            email,
            password: hashedPassword
        });

        return user;
    } catch (error) {
        throw new Error('–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');
    }
}

async function loginUser(email, password) {
    try {
        const user = await User.findOne({ where: { email } });
        if (!user) {
            throw new Error('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        }

        const isValidPassword = await verifyPassword(password, user.password);
        if (!isValidPassword) {
            throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å');
        }

        return user;
    } catch (error) {
        throw new Error('–ü–æ–º–∏–ª–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó');
    }
}
```

–ü–∞—Ä–∞–º–µ—Ç—Ä saltRounds –≤–∏–∑–Ω–∞—á–∞—î —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –æ–±—á–∏—Å–ª–µ–Ω—å. –ë—ñ–ª—å—à–µ –∑–Ω–∞—á–µ–Ω–Ω—è –æ–∑–Ω–∞—á–∞—î –≤–∏—â—É –±–µ–∑–ø–µ–∫—É, –∞–ª–µ –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è. –ó–∞–∑–≤–∏—á–∞–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –∑–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥ 10 –¥–æ 15.

## Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó

Middleware —î –∫–ª—é—á–æ–≤–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º –¥–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –≤ Express.js –¥–æ–¥–∞—Ç–∫–∞—Ö. –í—ñ–Ω –¥–æ–∑–≤–æ–ª—è—î —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –æ–±—Ä–æ–±–ª—è—Ç–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é.

### –ë–∞–∑–æ–≤–∏–π middleware –¥–ª—è JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó

```javascript
const jwt = require('jsonwebtoken');

// Middleware –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ JWT —Ç–æ–∫–µ–Ω–∞
function authenticateToken(req, res, next) {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

    if (!token) {
        return res.status(401).json({
            error: '–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø—É –≤—ñ–¥—Å—É—Ç–Ω—ñ–π'
        });
    }

    jwt.verify(token, process.env.JWT_SECRET, (error, user) => {
        if (error) {
            return res.status(403).json({
                error: '–ù–µ–¥—ñ–π—Å–Ω–∏–π —Ç–æ–∫–µ–Ω'
            });
        }

        req.user = user;
        next();
    });
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è middleware
app.get('/protected', authenticateToken, (req, res) => {
    res.json({
        message: '–î–æ—Å—Ç—É–ø –¥–æ–∑–≤–æ–ª–µ–Ω–æ',
        user: req.user
    });
});
```

### –†–æ–∑—à–∏—Ä–µ–Ω–∏–π middleware –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫

```javascript
// –†–æ–∑—à–∏—Ä–µ–Ω–∏–π middleware –∑ –¥–µ—Ç–∞–ª—å–Ω–æ—é –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
function authenticateTokenAdvanced(req, res, next) {
    const authHeader = req.headers['authorization'];

    if (!authHeader) {
        return res.status(401).json({
            error: 'Authorization header –≤—ñ–¥—Å—É—Ç–Ω—ñ–π',
            code: 'NO_AUTH_HEADER'
        });
    }

    const parts = authHeader.split(' ');
    if (parts.length !== 2 || parts[0] !== 'Bearer') {
        return res.status(401).json({
            error: '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç Authorization header',
            code: 'INVALID_AUTH_FORMAT'
        });
    }

    const token = parts[1];

    try {
        const decoded = jwt.verify(token, process.env.JWT_SECRET);

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–µ—Ä–º—ñ–Ω—É –¥—ñ—ó
        if (decoded.exp < Date.now() / 1000) {
            return res.status(401).json({
                error: '–¢–æ–∫–µ–Ω –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π',
                code: 'TOKEN_EXPIRED'
            });
        }

        req.user = decoded;
        next();
    } catch (error) {
        if (error.name === 'JsonWebTokenError') {
            return res.status(403).json({
                error: '–ù–µ–¥—ñ–π—Å–Ω–∏–π —Ç–æ–∫–µ–Ω',
                code: 'INVALID_TOKEN'
            });
        } else if (error.name === 'TokenExpiredError') {
            return res.status(401).json({
                error: '–¢–æ–∫–µ–Ω –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π',
                code: 'TOKEN_EXPIRED'
            });
        } else {
            return res.status(500).json({
                error: '–ü–æ–º–∏–ª–∫–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ç–æ–∫–µ–Ω–∞',
                code: 'VERIFICATION_ERROR'
            });
        }
    }
}
```

### Middleware –¥–ª—è refresh —Ç–æ–∫–µ–Ω—ñ–≤

```javascript
// –°–∏—Å—Ç–µ–º–∞ refresh —Ç–æ–∫–µ–Ω—ñ–≤ –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏
function generateTokens(user) {
    const accessToken = jwt.sign(
        {
            userId: user.id,
            email: user.email,
            role: user.role
        },
        process.env.JWT_SECRET,
        { expiresIn: '15m' } // –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ—Ä–º—ñ–Ω –¥–ª—è access token
    );

    const refreshToken = jwt.sign(
        { userId: user.id },
        process.env.REFRESH_TOKEN_SECRET,
        { expiresIn: '7d' } // –î–æ–≤—à–∏–π —Ç–µ—Ä–º—ñ–Ω –¥–ª—è refresh token
    );

    return { accessToken, refreshToken };
}

// Endpoint –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤
app.post('/refresh-token', async (req, res) => {
    const { refreshToken } = req.body;

    if (!refreshToken) {
        return res.status(401).json({ error: 'Refresh token –≤—ñ–¥—Å—É—Ç–Ω—ñ–π' });
    }

    try {
        const decoded = jwt.verify(refreshToken, process.env.REFRESH_TOKEN_SECRET);
        const user = await User.findById(decoded.userId);

        if (!user) {
            return res.status(403).json({ error: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ' });
        }

        const tokens = generateTokens(user);
        res.json(tokens);
    } catch (error) {
        return res.status(403).json({ error: '–ù–µ–¥—ñ–π—Å–Ω–∏–π refresh token' });
    }
});
```

## –†–æ–ª—ñ —Ç–∞ –¥–æ–∑–≤–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

–°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π —Ç–∞ –¥–æ–∑–≤–æ–ª—ñ–≤ —î –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ—é –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —Ç–æ–≥–æ, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–∞—é—Ç—å –¥–æ—Å—Ç—É–ø —Ç—ñ–ª—å–∫–∏ –¥–æ —Ç–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ–π, —è–∫—ñ —ó–º –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —ó—Ö –æ–±–æ–≤'—è–∑–∫—ñ–≤.

### RBAC (Role-Based Access Control)

RBAC —î –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–æ—é –º–æ–¥–µ–ª–ª—é –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É, –¥–µ –¥–æ–∑–≤–æ–ª–∏ –Ω–∞–¥–∞—é—Ç—å—Å—è —Ä–æ–ª—è–º, –∞ —Ä–æ–ª—ñ –ø—Ä–∏–∑–Ω–∞—á–∞—é—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º.

```javascript
// –ú–æ–¥–µ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ä–æ–ª—è–º–∏
const userSchema = {
    id: 'string',
    email: 'string',
    password: 'string',
    roles: ['admin', 'moderator', 'user'], // –ú–Ω–æ–∂–∏–Ω–Ω—ñ —Ä–æ–ª—ñ
    permissions: ['read:posts', 'write:posts', 'delete:posts'],
    isActive: 'boolean',
    createdAt: 'date'
};

// Middleware –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ä–æ–ª–µ–π
function requireRole(roles) {
    return (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({ error: '–ù–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ' });
        }

        const userRoles = req.user.roles || [];
        const hasRequiredRole = roles.some(role => userRoles.includes(role));

        if (!hasRequiredRole) {
            return res.status(403).json({
                error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É',
                required: roles,
                current: userRoles
            });
        }

        next();
    };
}

// Middleware –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ–∑–≤–æ–ª—ñ–≤
function requirePermission(permission) {
    return (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({ error: '–ù–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ' });
        }

        const userPermissions = req.user.permissions || [];
        if (!userPermissions.includes(permission)) {
            return res.status(403).json({
                error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–æ–∑–≤–æ–ª—ñ–≤',
                required: permission,
                current: userPermissions
            });
        }

        next();
    };
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –º–∞—Ä—à—Ä—É—Ç–∞—Ö
app.get('/admin/users',
    authenticateToken,
    requireRole(['admin']),
    (req, res) => {
        // –¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
    }
);

app.delete('/posts/:id',
    authenticateToken,
    requirePermission('delete:posts'),
    (req, res) => {
        // –¢—ñ–ª—å–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ –¥–æ–∑–≤–æ–ª–æ–º –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ—Å—Ç—ñ–≤
    }
);
```

### –†–æ–∑—à–∏—Ä–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–∑–≤–æ–ª—ñ–≤

```javascript
// –ö–ª–∞—Å –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–æ–∑–≤–æ–ª–∞–º–∏
class PermissionManager {
    constructor() {
        this.rolePermissions = {
            admin: [
                'users:create', 'users:read', 'users:update', 'users:delete',
                'posts:create', 'posts:read', 'posts:update', 'posts:delete',
                'comments:create', 'comments:read', 'comments:update', 'comments:delete'
            ],
            moderator: [
                'posts:read', 'posts:update', 'posts:delete',
                'comments:read', 'comments:update', 'comments:delete'
            ],
            user: [
                'posts:read', 'posts:create',
                'comments:read', 'comments:create'
            ]
        };
    }

    getUserPermissions(user) {
        const permissions = new Set();

        // –î–æ–¥–∞—Ç–∏ –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–æ–ª–µ–π
        if (user.roles) {
            user.roles.forEach(role => {
                if (this.rolePermissions[role]) {
                    this.rolePermissions[role].forEach(permission => {
                        permissions.add(permission);
                    });
                }
            });
        }

        // –î–æ–¥–∞—Ç–∏ —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ –¥–æ–∑–≤–æ–ª–∏
        if (user.permissions) {
            user.permissions.forEach(permission => {
                permissions.add(permission);
            });
        }

        return Array.from(permissions);
    }

    hasPermission(user, requiredPermission) {
        const userPermissions = this.getUserPermissions(user);
        return userPermissions.includes(requiredPermission);
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ —Ä–µ—Å—É—Ä—Å—É
    canAccessResource(user, resource, action) {
        const permission = `${resource}:${action}`;

        // –ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ–∑–≤—ñ–ª
        if (this.hasPermission(user, permission)) {
            return true;
        }

        // –î–æ–∑–≤—ñ–ª –Ω–∞ –≤–ª–∞—Å–Ω—ñ —Ä–µ—Å—É—Ä—Å–∏
        const ownPermission = `own:${resource}:${action}`;
        if (this.hasPermission(user, ownPermission)) {
            return true; // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—ñ
        }

        return false;
    }
}

const permissionManager = new PermissionManager();

// Middleware –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º PermissionManager
function requirePermissionAdvanced(resource, action) {
    return (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({ error: '–ù–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ' });
        }

        if (!permissionManager.canAccessResource(req.user, resource, action)) {
            return res.status(403).json({
                error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–æ–∑–≤–æ–ª—ñ–≤',
                required: `${resource}:${action}`
            });
        }

        next();
    };
}
```

## CORS, CSRF, XSS –∑–∞—Ö–∏—Å—Ç

### Cross-Origin Resource Sharing (CORS)

CORS –∫–æ–Ω—Ç—Ä–æ–ª—é—î, —è–∫—ñ –¥–æ–º–µ–Ω–∏ –º–æ–∂—É—Ç—å —Ä–æ–±–∏—Ç–∏ –∑–∞–ø–∏—Ç–∏ –¥–æ –≤–∞—à–æ–≥–æ API. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CORS –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Å–µ—Ä–π–æ–∑–Ω—ñ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ –±–µ–∑–ø–µ–∫–∏.

```javascript
const cors = require('cors');

// –ë–∞–∑–æ–≤–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CORS
app.use(cors({
    origin: function (origin, callback) {
        // –°–ø–∏—Å–æ–∫ –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö –¥–æ–º–µ–Ω—ñ–≤
        const allowedOrigins = [
            'https://yourdomain.com',
            'https://api.yourdomain.com',
            'http://localhost:3000' // –î–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏
        ];

        // –î–æ–∑–≤–æ–ª–∏—Ç–∏ –∑–∞–ø–∏—Ç–∏ –±–µ–∑ origin (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –º–æ–±—ñ–ª—å–Ω—ñ –¥–æ–¥–∞—Ç–∫–∏)
        if (!origin) return callback(null, true);

        if (allowedOrigins.includes(origin)) {
            callback(null, true);
        } else {
            callback(new Error('–ù–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ CORS –ø–æ–ª—ñ—Ç–∏–∫–æ—é'));
        }
    },
    credentials: true, // –î–æ–∑–≤–æ–ª–∏—Ç–∏ cookies
    methods: ['GET', 'POST', 'PUT', 'DELETE'],
    allowedHeaders: ['Content-Type', 'Authorization']
}));
```

### Cross-Site Request Forgery (CSRF) –∑–∞—Ö–∏—Å—Ç

CSRF –∞—Ç–∞–∫–∏ –∑–º—É—à—É—é—Ç—å –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –Ω–µ–±–∞–∂–∞–Ω—ñ –¥—ñ—ó –Ω–∞ –≤–µ–±—Å–∞–π—Ç—ñ.

```javascript
const csrf = require('csurf');

// –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CSRF –∑–∞—Ö–∏—Å—Ç—É
const csrfProtection = csrf({
    cookie: {
        httpOnly: true,
        secure: process.env.NODE_ENV === 'production',
        sameSite: 'strict'
    }
});

// –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è CSRF –∑–∞—Ö–∏—Å—Ç—É –¥–æ —Ñ–æ—Ä–º
app.use('/api', csrfProtection);

// Endpoint –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è CSRF —Ç–æ–∫–µ–Ω–∞
app.get('/csrf-token', csrfProtection, (req, res) => {
    res.json({ csrfToken: req.csrfToken() });
});

// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ - Double Submit Cookie
function generateCSRFToken() {
    return crypto.randomBytes(32).toString('hex');
}

function validateCSRF(req, res, next) {
    const headerToken = req.headers['x-csrf-token'];
    const cookieToken = req.cookies['csrf-token'];

    if (!headerToken || !cookieToken || headerToken !== cookieToken) {
        return res.status(403).json({ error: 'CSRF —Ç–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π' });
    }

    next();
}
```

### Cross-Site Scripting (XSS) –∑–∞—Ö–∏—Å—Ç

XSS –∞—Ç–∞–∫–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π JavaScript –∫–æ–¥ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.

```javascript
const helmet = require('helmet');
const DOMPurify = require('dompurify');
const { JSDOM } = require('jsdom');

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è Helmet –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ XSS –∑–∞—Ö–∏—Å—Ç—É
app.use(helmet({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            scriptSrc: ["'self'", "'unsafe-inline'"],
            styleSrc: ["'self'", "'unsafe-inline'"],
            imgSrc: ["'self'", "data:", "https:"],
        },
    },
    hsts: {
        maxAge: 31536000,
        includeSubDomains: true,
        preload: true
    }
}));

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è HTML –∫–æ–Ω—Ç–µ–Ω—Ç—É
function sanitizeHTML(dirty) {
    const window = new JSDOM('').window;
    const purify = DOMPurify(window);

    return purify.sanitize(dirty, {
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'p', 'br'],
        ALLOWED_ATTR: []
    });
}

// Middleware –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Ç–∞ –æ—á–∏—â–µ–Ω–Ω—è –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö
function validateAndSanitize(req, res, next) {
    if (req.body) {
        for (const key in req.body) {
            if (typeof req.body[key] === 'string') {
                // –ë–∞–∑–æ–≤–µ –æ—á–∏—â–µ–Ω–Ω—è –≤—ñ–¥ XSS
                req.body[key] = req.body[key]
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;')
                    .replace(/\//g, '&#x2F;');
            }
        }
    }
    next();
}

app.use(validateAndSanitize);
```

## Best practices –±–µ–∑–ø–µ–∫–∏

### –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑–ø–µ–∫–∏

```javascript
// –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –±–µ–∑–ø–µ–∫–∏
const securityConfig = {
    password: {
        minLength: 8,
        requireUppercase: true,
        requireLowercase: true,
        requireNumbers: true,
        requireSpecialChars: true,
        maxAge: 90 * 24 * 60 * 60 * 1000 // 90 –¥–Ω—ñ–≤
    },
    session: {
        maxAge: 24 * 60 * 60 * 1000, // 24 –≥–æ–¥–∏–Ω–∏
        secure: process.env.NODE_ENV === 'production',
        httpOnly: true,
        sameSite: 'strict'
    },
    rateLimit: {
        windowMs: 15 * 60 * 1000, // 15 —Ö–≤–∏–ª–∏–Ω
        max: 100 // –º–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ –≤—ñ–∫–Ω–æ
    }
};

// Rate limiting –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ brute-force –∞—Ç–∞–∫
const rateLimit = require('express-rate-limit');

const authLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 —Ö–≤–∏–ª–∏–Ω
    max: 5, // –º–∞–∫—Å–∏–º—É–º 5 —Å–ø—Ä–æ–± –≤—Ö–æ–¥—É
    message: {
        error: '–ó–∞–±–∞–≥–∞—Ç–æ —Å–ø—Ä–æ–± –≤—Ö–æ–¥—É, —Å–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 15 —Ö–≤–∏–ª–∏–Ω'
    },
    standardHeaders: true,
    legacyHeaders: false,
});

app.use('/auth/login', authLimiter);

// –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–∞—Ä–æ–ª—è
function validatePassword(password) {
    const config = securityConfig.password;
    const errors = [];

    if (password.length < config.minLength) {
        errors.push(`–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ –º—ñ–Ω—ñ–º—É–º ${config.minLength} —Å–∏–º–≤–æ–ª—ñ–≤`);
    }

    if (config.requireUppercase && !/[A-Z]/.test(password)) {
        errors.push('–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ –≤–µ–ª–∏–∫—ñ –ª—ñ—Ç–µ—Ä–∏');
    }

    if (config.requireLowercase && !/[a-z]/.test(password)) {
        errors.push('–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ –º–∞–ª—ñ –ª—ñ—Ç–µ—Ä–∏');
    }

    if (config.requireNumbers && !/\d/.test(password)) {
        errors.push('–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ —Ü–∏—Ñ—Ä–∏');
    }

    if (config.requireSpecialChars && !/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
        errors.push('–ü–∞—Ä–æ–ª—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ —Å–∏–º–≤–æ–ª–∏');
    }

    return {
        isValid: errors.length === 0,
        errors
    };
}

// –õ–æ–≥—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏
const securityLogger = require('winston').createLogger({
    level: 'info',
    format: require('winston').format.json(),
    transports: [
        new require('winston').transports.File({ filename: 'security.log' })
    ]
});

function logSecurityEvent(type, details, req) {
    securityLogger.info({
        type,
        details,
        ip: req.ip,
        userAgent: req.get('User-Agent'),
        timestamp: new Date().toISOString(),
        userId: req.user?.id
    });
}

// Middleware –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥–æ–∑—Ä—ñ–ª–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
function detectSuspiciousActivity(req, res, next) {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ SQL injection —Å–ø—Ä–æ–±–∏
    const suspiciousPatterns = [
        /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER)\b)/i,
        /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
        /javascript:/i
    ];

    const requestBody = JSON.stringify(req.body);
    const requestQuery = JSON.stringify(req.query);

    for (const pattern of suspiciousPatterns) {
        if (pattern.test(requestBody) || pattern.test(requestQuery)) {
            logSecurityEvent('SUSPICIOUS_ACTIVITY', {
                pattern: pattern.toString(),
                body: req.body,
                query: req.query
            }, req);

            return res.status(400).json({
                error: '–ü—ñ–¥–æ–∑—Ä—ñ–ª–∏–π –∑–∞–ø–∏—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ'
            });
        }
    }

    next();
}

app.use(detectSuspiciousActivity);
```

### –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –∞–ª–µ—Ä—Ç–∏

```javascript
// –°–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç—ñ–≤ –±–µ–∑–ø–µ–∫–∏
class SecurityMonitor {
    constructor() {
        this.suspiciousActivities = new Map();
        this.rateLimits = new Map();
    }

    trackFailedLogin(ip, email) {
        const key = `${ip}:${email}`;
        const attempts = this.suspiciousActivities.get(key) || 0;

        this.suspiciousActivities.set(key, attempts + 1);

        if (attempts >= 3) {
            this.sendAlert('MULTIPLE_FAILED_LOGINS', {
                ip,
                email,
                attempts: attempts + 1
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 1 –≥–æ–¥–∏–Ω—É
        setTimeout(() => {
            this.suspiciousActivities.delete(key);
        }, 60 * 60 * 1000);
    }

    async sendAlert(type, details) {
        // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç—É –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
        console.log(`SECURITY ALERT: ${type}`, details);

        // –ú–æ–∂–Ω–∞ —ñ–Ω—Ç–µ–≥—Ä—É–≤–∞—Ç–∏ –∑ email, Slack, —Ç–æ—â–æ
        if (process.env.SLACK_WEBHOOK_URL) {
            await this.sendSlackAlert(type, details);
        }
    }

    async sendSlackAlert(type, details) {
        const webhook = process.env.SLACK_WEBHOOK_URL;
        const message = {
            text: `üö® Security Alert: ${type}`,
            attachments: [{
                color: 'danger',
                fields: Object.entries(details).map(([key, value]) => ({
                    title: key,
                    value: value.toString(),
                    short: true
                }))
            }]
        };

        try {
            await fetch(webhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(message)
            });
        } catch (error) {
            console.error('Failed to send Slack alert:', error);
        }
    }
}

const securityMonitor = new SecurityMonitor();
```

### –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —á—É—Ç–ª–∏–≤–∏—Ö –¥–∞–Ω–∏—Ö

```javascript
const crypto = require('crypto');

// –ö–ª–∞—Å –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —á—É—Ç–ª–∏–≤–∏—Ö –¥–∞–Ω–∏—Ö
class DataEncryption {
    constructor() {
        this.algorithm = 'aes-256-gcm';
        this.secretKey = process.env.ENCRYPTION_KEY || crypto.randomBytes(32);
    }

    encrypt(text) {
        const iv = crypto.randomBytes(16);
        const cipher = crypto.createCipher(this.algorithm, this.secretKey);
        cipher.setAAD(Buffer.from('additional-data'));

        let encrypted = cipher.update(text, 'utf8', 'hex');
        encrypted += cipher.final('hex');

        const authTag = cipher.getAuthTag();

        return {
            encrypted,
            iv: iv.toString('hex'),
            authTag: authTag.toString('hex')
        };
    }

    decrypt(encryptedData) {
        const { encrypted, iv, authTag } = encryptedData;

        const decipher = crypto.createDecipher(this.algorithm, this.secretKey);
        decipher.setAAD(Buffer.from('additional-data'));
        decipher.setAuthTag(Buffer.from(authTag, 'hex'));

        let decrypted = decipher.update(encrypted, 'hex', 'utf8');
        decrypted += decipher.final('utf8');

        return decrypted;
    }
}

const dataEncryption = new DataEncryption();

// –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –¥–ª—è PII (Personally Identifiable Information)
async function saveUserSensitiveData(userId, sensitiveData) {
    const encrypted = dataEncryption.encrypt(JSON.stringify(sensitiveData));

    await UserSensitiveData.create({
        userId,
        encryptedData: encrypted.encrypted,
        iv: encrypted.iv,
        authTag: encrypted.authTag
    });
}
```

### –ê—É–¥–∏—Ç –±–µ–∑–ø–µ–∫–∏ —Ç–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è

```javascript
// –°–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏—Ç—É –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –¥—ñ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
class SecurityAudit {
    constructor() {
        this.auditLogger = require('winston').createLogger({
            level: 'info',
            format: require('winston').format.combine(
                require('winston').format.timestamp(),
                require('winston').format.json()
            ),
            transports: [
                new require('winston').transports.File({
                    filename: 'audit.log',
                    maxsize: 5242880, // 5MB
                    maxFiles: 5
                })
            ]
        });
    }

    logAction(action, userId, details = {}, req = null) {
        const auditEntry = {
            action,
            userId,
            details,
            timestamp: new Date().toISOString(),
            ip: req?.ip,
            userAgent: req?.get('User-Agent'),
            sessionId: req?.sessionID
        };

        this.auditLogger.info(auditEntry);

        // –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –∫—Ä–∏—Ç–∏—á–Ω—ñ –¥—ñ—ó –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
        if (this.isCriticalAction(action)) {
            this.saveToDatabase(auditEntry);
        }
    }

    isCriticalAction(action) {
        const criticalActions = [
            'USER_LOGIN',
            'USER_LOGOUT',
            'PASSWORD_CHANGE',
            'PERMISSION_CHANGE',
            'ADMIN_ACCESS',
            'DATA_EXPORT',
            'ACCOUNT_DELETION'
        ];

        return criticalActions.includes(action);
    }

    async saveToDatabase(auditEntry) {
        try {
            await AuditLog.create(auditEntry);
        } catch (error) {
            console.error('Failed to save audit log to database:', error);
        }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–≤—ñ—Ç—ñ–≤ –∞—É–¥–∏—Ç—É
    async generateSecurityReport(startDate, endDate) {
        const logs = await AuditLog.findAll({
            where: {
                timestamp: {
                    [Op.between]: [startDate, endDate]
                }
            },
            order: [['timestamp', 'DESC']]
        });

        const report = {
            period: { startDate, endDate },
            totalActions: logs.length,
            uniqueUsers: new Set(logs.map(log => log.userId)).size,
            actionBreakdown: {},
            suspiciousActivities: []
        };

        // –ê–Ω–∞–ª—ñ–∑ –¥—ñ–π
        logs.forEach(log => {
            report.actionBreakdown[log.action] =
                (report.actionBreakdown[log.action] || 0) + 1;
        });

        // –í–∏—è–≤–ª–µ–Ω–Ω—è –ø—ñ–¥–æ–∑—Ä—ñ–ª–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
        report.suspiciousActivities = this.detectSuspiciousPatterns(logs);

        return report;
    }

    detectSuspiciousPatterns(logs) {
        const suspicious = [];
        const userActions = {};

        // –ì—Ä—É–ø—É–≤–∞—Ç–∏ –¥—ñ—ó –∑–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏
        logs.forEach(log => {
            if (!userActions[log.userId]) {
                userActions[log.userId] = [];
            }
            userActions[log.userId].push(log);
        });

        // –ê–Ω–∞–ª—ñ–∑ –ø–∞—Ç—Ç–µ—Ä–Ω—ñ–≤
        Object.entries(userActions).forEach(([userId, actions]) => {
            // –ó–∞–±–∞–≥–∞—Ç–æ –Ω–µ–≤–¥–∞–ª–∏—Ö —Å–ø—Ä–æ–± –≤—Ö–æ–¥—É
            const failedLogins = actions.filter(a => a.action === 'FAILED_LOGIN');
            if (failedLogins.length > 5) {
                suspicious.push({
                    type: 'EXCESSIVE_FAILED_LOGINS',
                    userId,
                    count: failedLogins.length
                });
            }

            // –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤ –Ω–µ–∑–≤–∏—á–Ω–∏–π —á–∞—Å
            const nightActivity = actions.filter(a => {
                const hour = new Date(a.timestamp).getHours();
                return hour < 6 || hour > 22;
            });

            if (nightActivity.length > 10) {
                suspicious.push({
                    type: 'UNUSUAL_TIME_ACTIVITY',
                    userId,
                    count: nightActivity.length
                });
            }
        });

        return suspicious;
    }
}

const securityAudit = new SecurityAudit();

// Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è
function auditMiddleware(action) {
    return (req, res, next) => {
        const originalSend = res.send;

        res.send = function(data) {
            // –õ–æ–≥—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —É—Å–ø—ñ—à–Ω—ñ –¥—ñ—ó (status < 400)
            if (res.statusCode < 400) {
                securityAudit.logAction(action, req.user?.id, {
                    method: req.method,
                    url: req.originalUrl,
                    statusCode: res.statusCode
                }, req);
            }

            originalSend.call(this, data);
        };

        next();
    };
}
```

### –ë–µ–∑–ø–µ—á–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

```javascript
// –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
const productionSecuritySetup = (app) => {
    // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Ç–µ—Ö–Ω—ñ—á–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
    app.disable('x-powered-by');

    // –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –±–µ–∑–ø–µ—á–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    app.use((req, res, next) => {
        res.setHeader('X-Content-Type-Options', 'nosniff');
        res.setHeader('X-Frame-Options', 'DENY');
        res.setHeader('X-XSS-Protection', '1; mode=block');
        res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
        res.setHeader('Permissions-Policy', 'geolocation=(), microphone=(), camera=()');
        next();
    });

    // HTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç
    if (process.env.NODE_ENV === 'production') {
        app.use((req, res, next) => {
            if (req.header('x-forwarded-proto') !== 'https') {
                res.redirect(`https://${req.header('host')}${req.url}`);
            } else {
                next();
            }
        });
    }

    // –ë–µ–∑–ø–µ—á–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è cookies
    app.use(session({
        secret: process.env.SESSION_SECRET,
        resave: false,
        saveUninitialized: false,
        cookie: {
            secure: true, // –¢—ñ–ª—å–∫–∏ HTTPS
            httpOnly: true, // –ù–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π —á–µ—Ä–µ–∑ JavaScript
            maxAge: 24 * 60 * 60 * 1000, // 24 –≥–æ–¥–∏–Ω–∏
            sameSite: 'strict' // CSRF –∑–∞—Ö–∏—Å—Ç
        },
        store: new RedisStore({
            client: redisClient,
            prefix: 'sess:'
        })
    }));
};

// –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
function validateEnvironmentVariables() {
    const required = [
        'JWT_SECRET',
        'REFRESH_TOKEN_SECRET',
        'DATABASE_URL',
        'SESSION_SECRET',
        'ENCRYPTION_KEY'
    ];

    const missing = required.filter(variable => !process.env[variable]);

    if (missing.length > 0) {
        console.error('Missing required environment variables:', missing);
        process.exit(1);
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ —Å–µ–∫—Ä–µ—Ç—ñ–≤
    if (process.env.JWT_SECRET.length < 32) {
        console.error('JWT_SECRET must be at least 32 characters long');
        process.exit(1);
    }
}

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ
if (process.env.NODE_ENV === 'production') {
    validateEnvironmentVariables();
    productionSecuritySetup(app);
}
```

## –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —Ç–∞ —á–µ–∫–ª—ñ—Å—Ç –±–µ–∑–ø–µ–∫–∏

### –ß–µ–∫–ª—ñ—Å—Ç –±–µ–∑–ø–µ–∫–∏ –¥–ª—è –≤–µ–±–¥–æ–¥–∞—Ç–∫—ñ–≤

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ bcrypt –¥–ª—è —Ö–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤ –∑ salt rounds >= 10
- –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Å–∏—Å—Ç–µ–º—É refresh —Ç–æ–∫–µ–Ω—ñ–≤ –¥–ª—è JWT
- –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó –¥–ª—è access —Ç–æ–∫–µ–Ω—ñ–≤ (15-30 —Ö–≤–∏–ª–∏–Ω)
- –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ rate limiting –¥–ª—è endpoints –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
- –õ–æ–≥—É–≤–∞—Ç–∏ –≤—Å—ñ —Å–ø—Ä–æ–±–∏ –≤—Ö–æ–¥—É —Ç–∞ –ø—ñ–¥–æ–∑—Ä—ñ–ª—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

**–ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∞—Ç–∞–∫:**
- –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ CORS –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –ø–æ—Ç—Ä–µ–± –¥–æ–¥–∞—Ç–∫—É
- –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ CSRF –∑–∞—Ö–∏—Å—Ç –¥–ª—è state-changing –æ–ø–µ—Ä–∞—Ü—ñ–π
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Content Security Policy (CSP)
- –í–∞–ª—ñ–¥—É–≤–∞—Ç–∏ —Ç–∞ —Å–∞–Ω—ñ—Ç–∏–∑—É–≤–∞—Ç–∏ –≤—Å—ñ –≤—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω—ñ –∑–∞–ø–∏—Ç–∏ –¥–ª—è –ë–î

**–®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ—Å—Ç—å:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ
- –®–∏—Ñ—Ä—É–≤–∞—Ç–∏ —á—É—Ç–ª–∏–≤—ñ –¥–∞–Ω—ñ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±–µ–∑–ø–µ—á–Ω—ñ –º–µ—Ç–æ–¥–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å–µ–∫—Ä–µ—Ç—ñ–≤
- –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç—É–≤–∞—Ç–∏ –∫–ª—é—á—ñ —Ç–∞ –ø–∞—Ä–æ–ª—ñ

**–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –∞—É–¥–∏—Ç:**
- –õ–æ–≥—É–≤–∞—Ç–∏ –≤—Å—ñ –±–µ–∑–ø–µ–∫–æ–≤—ñ –ø–æ–¥—ñ—ó
- –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –∞–ª–µ—Ä—Ç–∏ –¥–ª—è –ø—ñ–¥–æ–∑—Ä—ñ–ª–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
- –†–µ–≥—É–ª—è—Ä–Ω–æ –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ª–æ–≥–∏ –±–µ–∑–ø–µ–∫–∏
- –°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–ø—ñ—ó –∞—É–¥–∏—Ç –ª–æ–≥—ñ–≤

### –¢–∏–ø–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏ –±–µ–∑–ø–µ–∫–∏

–ù–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏–º–∏ –ø–æ–º–∏–ª–∫–∞–º–∏ –≤ –±–µ–∑–ø–µ—Ü—ñ –≤–µ–±–¥–æ–¥–∞—Ç–∫—ñ–≤ —î: –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤ —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É –≤–∏–≥–ª—è–¥—ñ, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å–ª–∞–±–∫–∏—Ö –∞–ª–≥–æ—Ä–∏—Ç–º—ñ–≤ —Ö–µ—à—É–≤–∞–Ω–Ω—è, –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å rate limiting, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CORS, —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è HTTP –∑–∞–º—ñ—Å—Ç—å HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ, –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å–µ–∫—Ä–µ—Ç—ñ–≤ —É –∫–æ–¥—ñ, –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –ª–æ–≥—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–æ–≤–∏—Ö –ø–æ–¥—ñ–π.

### –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏

–î–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±–µ–∑–ø–µ–∫–∏ –≤–µ–±–¥–æ–¥–∞—Ç–∫—ñ–≤ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏: OWASP ZAP –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–æ–≥–æ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç–µ–π, Burp Suite –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è, npm audit –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç–µ–π —É –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è—Ö, ESLint security –ø–ª–∞–≥—ñ–Ω–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É –∫–æ–¥—É, Snyk –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –±–µ–∑–ø–µ–∫–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π.

## –í–∏—Å–Ω–æ–≤–∫–∏

–ë–µ–∑–ø–µ–∫–∞ –≤–µ–±–¥–æ–¥–∞—Ç–∫—ñ–≤ —î –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ—é –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–æ—é, —è–∫–∞ –≤–∏–º–∞–≥–∞—î –ø–æ—Å—Ç—ñ–π–Ω–æ—ó —É–≤–∞–≥–∏ —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–Ω–∞–Ω—å. –ü—Ä–∞–≤–∏–ª—å–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å—É—á–∞—Å–Ω–∏—Ö –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω–∏—Ö –º–µ—Ç–æ–¥—ñ–≤, –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–æ—à–∏—Ä–µ–Ω–∏—Ö –∞—Ç–∞–∫ —Ç–∞ –ø–æ—Å—Ç—ñ–π–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —î –æ—Å–Ω–æ–≤–Ω–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –≤–µ–±–¥–æ–¥–∞—Ç–∫—É.

–ù–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∏–º–∏ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º–∏ —î: –ø—Ä–∏–Ω—Ü–∏–ø –Ω–∞–π–º–µ–Ω—à–∏—Ö –ø—Ä–∏–≤—ñ–ª–µ—ó–≤, –≥–ª–∏–±–æ–∫–∏–π –∑–∞—Ö–∏—Å—Ç —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ —Ä—ñ–≤–Ω—ñ–≤ –±–µ–∑–ø–µ–∫–∏, —Ä–µ–≥—É–ª—è—Ä–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ —Ç–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π, –ø–æ—Å—Ç—ñ–π–Ω–µ –Ω–∞–≤—á–∞–Ω–Ω—è —Ç–∞ —Å–ª—ñ–¥—É–≤–∞–Ω–Ω—è –∑–∞ –Ω–æ–≤–∏–º–∏ –∑–∞–≥—Ä–æ–∑–∞–º–∏.

–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ –±–µ–∑–ø–µ–∫–∞ –Ω–µ —î –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—é –∑–∞–¥–∞—á–µ—é, –∞ –ø–æ—Å—Ç—ñ–π–Ω–∏–º –ø—Ä–æ—Ü–µ—Å–æ–º, —è–∫–∏–π –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∏–π —É –≤—Å—ñ –µ—Ç–∞–ø–∏ —Ä–æ–∑—Ä–æ–±–∫–∏ —Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –≤–µ–±–¥–æ–¥–∞—Ç–∫—É. –Ü–Ω–≤–µ—Å—Ç–∏—Ü—ñ—ó –≤ –±–µ–∑–ø–µ–∫—É –∑–∞–≤–∂–¥–∏ –º–µ–Ω—à—ñ –∑–∞ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –≤—Ç—Ä–∞—Ç–∏ –≤—ñ–¥ —É—Å–ø—ñ—à–Ω–∏—Ö –∞—Ç–∞–∫.

## –ü–∏—Ç–∞–Ω–Ω—è –¥–ª—è —Å–∞–º–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫–∏

1. –Ø–∫–∞ —Ä—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—î—é?
2. –ö–æ–ª–∏ –≤–∞—Ä—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å–µ—Å—ñ—ó, –∞ –∫–æ–ª–∏ JWT?
3. –ß–æ–º—É bcrypt –∫—Ä–∞—â–∏–π –∑–∞ SHA256 –¥–ª—è –ø–∞—Ä–æ–ª—ñ–≤?
4. –Ø–∫ –∑–∞—Ö–∏—Å—Ç–∏—Ç–∏—Å—è –≤—ñ–¥ CSRF –∞—Ç–∞–∫?
5. –©–æ —Ç–∞–∫–µ –ø—Ä–∏–Ω—Ü–∏–ø –Ω–∞–π–º–µ–Ω—à–∏—Ö –ø—Ä–∏–≤—ñ–ª–µ—ó–≤?
